<p>

    The
    <a href="https://developers.google.com/web/updates/2015/07/interact-with-ble-devices-on-the-web">Web Bluetooth API
    </a> lets websites discover and communicate with devices over the Bluetooth 4 wireless standard using the Generic Attribute
    Profile (GATT). It is currently partially implemented in Android M, Chrome OS, Linux, and Mac.</p>

<script>
    if ('serviceWorker' in navigator) {
        //navigator.serviceWorker.register('service-worker.js');
    }
</script>


<p>This sample illustrates the use of the Web Bluetooth API to retrieve basic device information from a nearby Bluetooth Low
    Energy Device. You may want to check out the
    <a href="device-info-async-await.html">Device Info (Async Await)
    </a> sample.</p>

<form>
    <label for="allDevices">All Devices</label>
    <input id="allDevices" type="checkbox">
    <input id="service" type="text" size=17 list="services" placeholder="Bluetooth Service">
    <input id="name" type="text" size=17 placeholder="Device Name">
    <input id="namePrefix" type="text" size=17 placeholder="Device Name Prefix">
    <button>Get Bluetooth Device Info</button>
</form>

<button onclick="escribir()">Get Bluetooth Device Info</button>

<datalist id="services">
    <option value="alert_notification">alert_notification</option>
    <option value="automation_io">automation_io</option>
    <option value="battery_service">battery_service</option>
    <option value="blood_pressure">blood_pressure</option>
    <option value="body_composition">body_composition</option>
    <option value="bond_management">bond_management</option>
    <option value="continuous_glucose_monitoring">continuous_glucose_monitoring</option>
    <option value="current_time">current_time</option>
    <option value="cycling_power">cycling_power</option>
    <option value="cycling_speed_and_cadence">cycling_speed_and_cadence</option>
    <option value="device_information">device_information</option>
    <option value="environmental_sensing">environmental_sensing</option>
    <option value="generic_access">generic_access</option>
    <option value="generic_attribute">generic_attribute</option>
    <option value="glucose">glucose</option>
    <option value="health_thermometer">health_thermometer</option>
    <option value="heart_rate">heart_rate</option>
    <option value="human_interface_device">human_interface_device (blacklisted)</option>
    <option value="immediate_alert">immediate_alert</option>
    <option value="indoor_positioning">indoor_positioning</option>
    <option value="internet_protocol_support">internet_protocol_support</option>
    <option value="link_loss">link_loss</option>
    <option value="location_and_navigation">location_and_navigation</option>
    <option value="next_dst_change">next_dst_change</option>
    <option value="phone_alert_status">phone_alert_status</option>
    <option value="pulse_oximeter">pulse_oximeter</option>
    <option value="reference_time_update">reference_time_update</option>
    <option value="running_speed_and_cadence">running_speed_and_cadence</option>
    <option value="scan_parameters">scan_parameters</option>
    <option value="tx_power">tx_power</option>
    <option value="user_data">user_data</option>
    <option value="weight_scale">weight_scale</option>
</datalist>

<!-->include output_helper.html -->
<script>
    //console.log = ChromeSamples.console.log;
    function isWebBluetoothEnabled() {
        if (navigator.bluetooth) {
            return true;
        } else {
            console.warn('Web Bluetooth API is not available.\n' +
                'Please make sure the "Experimental Web Platform features" flag is enabled.');
            return false;
        }
    }


    function onButtonClick() {
        let filters = [];

        let filterService = document.querySelector('#service').value;
        console.log("filterService", filterService);
        if (filterService.startsWith('0x')) {
            filterService = parseInt(filterService);
        }
        if (filterService) {
            filters.push({ services: [filterService] });
        }

        let filterName = document.querySelector('#name').value;
        console.log("filterName", filterName);
        if (filterName) {
            filters.push({ name: filterName });
        }

        let filterNamePrefix = document.querySelector('#namePrefix').value;
        if (filterNamePrefix) {
            filters.push({ namePrefix: filterNamePrefix });
        }

        let options = {};
        if (document.querySelector('#allDevices').checked) {
            options.acceptAllDevices = true;
        } else {
            options.filters = filters;
        }

        console.log('Requesting Bluetooth Device...');
        console.log('with ' + JSON.stringify(options));
        navigator.bluetooth.requestDevice(options)
            .then(device => {
                console.log('> Name:             ' + device.name);
                console.log('> Id:               ' + device.id);
                console.log('> Connected:        ' + device.gatt.connected);
                console.log(device);
            })
            .catch(error => {
                console.log('Argh! ' + error);
            });
    }


    async function onButtonClick2() {
        try {
            console.log('Requesting any Bluetooth Device...');
            const device = await navigator.bluetooth.requestDevice({
                // filters: [...] <- Prefer filters to save energy & show relevant devices.
                acceptAllDevices: true,
                optionalServices: ['device_information']
            });

            console.log('Connecting to GATT Server...');
            const server = await device.gatt.connect();

            console.log('Getting Device Information Service...');
            const service = await server.getPrimaryService('device_information');

            console.log('Getting Device Information Characteristics...');
            const characteristics = await service.getCharacteristics();

            const decoder = new TextDecoder('utf-8');
            for (const characteristic of characteristics) {
                switch (characteristic.uuid) {

                    case BluetoothUUID.getCharacteristic('manufacturer_name_string'):
                        await characteristic.readValue().then(value => {
                            console.log('> Manufacturer Name String: ' + decoder.decode(value));
                        });
                        break;

                    case BluetoothUUID.getCharacteristic('model_number_string'):
                        await characteristic.readValue().then(value => {
                            console.log('> Model Number String: ' + decoder.decode(value));
                        });
                        break;

                    case BluetoothUUID.getCharacteristic('hardware_revision_string'):
                        await characteristic.readValue().then(value => {
                            console.log('> Hardware Revision String: ' + decoder.decode(value));
                        });
                        break;

                    case BluetoothUUID.getCharacteristic('firmware_revision_string'):
                        await characteristic.readValue().then(value => {
                            console.log('> Firmware Revision String: ' + decoder.decode(value));
                        });
                        break;

                    case BluetoothUUID.getCharacteristic('software_revision_string'):
                        await characteristic.readValue().then(value => {
                            console.log('> Software Revision String: ' + decoder.decode(value));
                        });
                        break;

                    case BluetoothUUID.getCharacteristic('system_id'):
                        await characteristic.readValue().then(value => {
                            console.log('> System ID: ');
                            console.log('  > Manufacturer Identifier: ' +
                                padHex(value.getUint8(4)) + padHex(value.getUint8(3)) +
                                padHex(value.getUint8(2)) + padHex(value.getUint8(1)) +
                                padHex(value.getUint8(0)));
                            console.log('  > Organizationally Unique Identifier: ' +
                                padHex(value.getUint8(7)) + padHex(value.getUint8(6)) +
                                padHex(value.getUint8(5)));
                        });
                        break;

                    case BluetoothUUID.getCharacteristic('ieee_11073-20601_regulatory_certification_data_list'):
                        await characteristic.readValue().then(value => {
                            console.log('> IEEE 11073-20601 Regulatory Certification Data List: ' +
                                decoder.decode(value));
                        });
                        break;

                    case BluetoothUUID.getCharacteristic('pnp_id'):
                        await characteristic.readValue().then(value => {
                            console.log('> PnP ID:');
                            console.log('  > Vendor ID Source: ' +
                                (value.getUint8(0) === 1 ? 'Bluetooth' : 'USB'));
                            if (value.getUint8(0) === 1) {
                                console.log('  > Vendor ID: ' +
                                    (value.getUint8(1) | value.getUint8(2) << 8));
                            } else {
                                console.log('  > Vendor ID: ' +
                                    getUsbVendorName(value.getUint8(1) | value.getUint8(2) << 8));
                            }
                            console.log('  > Product ID: ' +
                                (value.getUint8(3) | value.getUint8(4) << 8));
                            console.log('  > Product Version: ' +
                                (value.getUint8(5) | value.getUint8(6) << 8));
                        });
                        break;

                    default: console.log('> Unknown Characteristic: ' + characteristic.uuid);
                }
            }
        } catch (error) {
            console.log('Argh! ' + error);
        }
    }

    /* Utils */

    function padHex(value) {
        return ('00' + value.toString(16).toUpperCase()).slice(-2);
    }

    function getUsbVendorName(value) {
        // Check out page source to see what valueToUsbVendorName object is.
        return value +
            (value in valueToUsbVendorName ? ' (' + valueToUsbVendorName[value] + ')' : '');
    }


    document.querySelector('form').addEventListener('submit', function (event) {
        event.stopPropagation();
        event.preventDefault();
        if (isWebBluetoothEnabled()) {
            console.warn("isWebBluetoothEnabled YESSSS");
            customFelix();
        }
        else {
            console.error("isWebBluetoothEnabled YESSSS");
        }
    });


    function onButtonClick3() {
        // Validate services UUID entered by user first.
        let optionalServices = ""
            .split(/, ?/).map(s => s.startsWith('0x') ? parseInt(s) : s)
            .filter(s => s && BluetoothUUID.getService);

        console.log('Requesting any Bluetooth Device...');
        navigator.bluetooth.requestDevice({
            // filters: [...] <- Prefer filters to save energy & show relevant devices.
            //acceptAllDevices: true,
            filters: [{ services: [0xb723] }]

        })
            .then(device => {
                console.log('Connecting to GATT Server...');
                return device.gatt.connect();
            })
            .then(server => {
                // Note that we could also get all services that match a specific UUID by
                // passing it to getPrimaryServices().
                console.log('Getting Services...');
                return server.getPrimaryServices();
            })
            .then(services => {
                console.log(services);
                console.log('Getting Characteristics...');
                let queue = Promise.resolve();
                services.forEach(service => {
                    queue = queue.then(_ => service.getCharacteristics().then(characteristics => {
                        console.log('> Service: ' + service.uuid);
                        characteristics.forEach(characteristic => {
                            console.log('>> Characteristic: ' + characteristic.uuid + ' ' +
                                getSupportedProperties(characteristic));
                        });
                    }));
                });
                return queue;
            })
            .catch(error => {
                console.log('Argh! ' + error);
            });
    }

    /* Utils */

    function getSupportedProperties(characteristic) {
        let supportedProperties = [];
        for (const p in characteristic.properties) {
            if (characteristic.properties[p] === true) {
                supportedProperties.push(p.toUpperCase());
            }
        }
        return '[' + supportedProperties.join(', ') + ']';
    }



    var myCharacteristic;
    function customFelix() {
        navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: ['0000ff20-0000-1000-8000-00805f9b34fb']
        })
            .then(device => device.gatt.connect())
            .then(server => server.getPrimaryService('0000ff20-0000-1000-8000-00805f9b34fb'))
            .then(service => {
                return Promise.all([
                    service.getCharacteristic('0000ff21-0000-1000-8000-00805f9b34fb')
                    .then(handleBodySensorLocationCharacteristic)
  ])
             }) 
            /*.then(characteristic => {
                console.log(characteristic);
                
                return characteristic.startNotifications()
  .then(() => {characteristic.addEventListener('characteristicvaluechanged',
                    handleCharacteristicValueChanged);});
                    myCharacteristic = characteristic;
                    console.log(myCharacteristic);
                
            })*/
            /*
            .then(characteristic => {
                // Reading Battery Level...
                //return characteristic.readValue().catch(err => console.log('readValue', err));
                var data = new Uint8Array([0x21, 0xFF, 0x29, 0x01, 0x01]);
                return characteristic.writeValue(data);
            })
            .then(characteristic => characteristic.startNotifications())
            .then(characteristic => {
                characteristic.addEventListener('characteristicvaluechanged',
                    handleCharacteristicValueChanged);
                console.log('Notifications have been started.');
            })*/
            /*
            .then(characteristic => {
                // Step 5: Write to the characteristic
                //21 FF 29 01 01
                var data = new Uint8Array([0x21, 0xFF, 0x29, 0x01, 0x01]);
                return characteristic.writeValue(data);
            })
            .then(characteristic => characteristic.startNotifications())
            .then(characteristic => {
                characteristic.addEventListener('characteristicvaluechanged',
                    handleCharacteristicValueChanged);
                console.log('Notifications have been started.');
            })*/
            .catch(function (error) {
                // And of course: error handling!
                console.error('Connection failed!', error);
            });
    }

    function handleBodySensorLocationCharacteristic(characteristic) {
        myCharacteristic = characteristic;
        return characteristic.startNotifications()
            .then(char => {
                characteristic.addEventListener('characteristicvaluechanged',
                    handleCharacteristicValueChanged);
            });
    }

    function handleCharacteristicValueChanged(event) {
        var value = event.target.value;
        console.log('Received ' + value);
        // TODO: Parse Heart Rate Measurement value.
        // See https://github.com/WebBluetoothCG/demos/blob/gh-pages/heart-rate-sensor/heartRateSensor.js
    }




    function escribir() {
        console.log('> escribir');
        var data = new Uint8Array([0x21, 0xFF, 0x29, 0x01, 0x01]);
        myCharacteristic.writeValue(data);
    }


</script>